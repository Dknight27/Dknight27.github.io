---
layout: post
title: blockchain
date: 2020-03-08
subtitle: 只有你的努力不会辜负你
author: SH
tags:
        -学习笔记
---

## 写在前面
1. 不要陷入细节陷阱
2. 带着目的去看代码
3. 使用debug模式看细节

## AMOP（链上信使协议）是什么？
为联盟提供安全高效的信息通道。不依赖节点共识，类似于消息队列的一个东西。AMOP可用于加快交易的速度，无需等待交易确认，只需一个对账（？）操作。

Application.xml中对不同的topic配置了各自的公钥，也就是说在配置时就要获取各节点的公钥，或许是发送topic时使用公钥加密，也就完成了topic的权限控制？

## Table.sol中的数据存储在哪里了？
似乎是储存在固定的位置了。因为TableFactory的地址就是固定的，所以猜想Table的存储位置也是固定的。

KVTable的表名是群组内全局可见且唯一的。

## 什么是观察节点&共识节点？什么是节点？？？
节点的存在感很强又很弱，强在所有的交易和合约部署以及出块都要由它们来做，弱在它们似乎只是背后的矿工，不能对它们进行实质性的操作。

现在理解的节点除了矿工的角色，还有一个接线员的角色，它是与其他节点相连的关键部分，只有当前机器中存在节点时，才能访问区块链。将对应IP的node文件拷贝到对应机器上，然后在对应机器上启动节点，猜测是这样子。（那拷贝之后需要将文件夹改为127.0.0.1吗？）


## 交易和合约都存储在区块上吗？有什么区别吗？

## 一个区块如何存储多个交易？交易是如何被打包的？（未解决）
区块打包交易一般是间隔一定的时间出块，或者块里面的交易达到一定的量也会出块。所以说存储交易多少是跟合约没有关系的。

## 配置console证书时 
    拷贝group2节点证书到控制台配置目录
    $ cp ~/fisco/nodes/127.0.0.1/sdk/* conf/
这不是拷贝所有群组节点的配置吗，为什么说是group2

## 控制台
1. 使用控制台连接节点
控制台连接的节点必须在控制台配置的组中
<font size=1>意思是用**控制台控制**节点之前必须要配置控制台</font>
2. getDeployLog只能查询**由当前控制台部署**的合约

## 智能合约
**合约名要和合约文件名一致**
合约主要分为以下几个构成部分：
1. 状态变量：如_admin，这些变量会永久保存（即存在链上），变量具有16个的上限，超过会报堆栈过深的错误（结构体只算一个变量）。memory变量是放在内存中的
2. 构造函数
3. 事件：类似于日志函数吧，主要作用是记录
4. 修饰符：类似于python中的修饰符，可以给函数套上一层功能
5. 函数
6. 结构体


## 关于jsonrpc_listen_port和channel_listen_port
jsonrpc可能是对本机进行一些操作，权限很大，如果对所有IP都开放那么本机会有危险。
channel可能是用来接受其他节点的一些请求，所以可以设置为0.0.0.0接受所有的IP

## 合约事件推送
合约事件推送功能提供了合约事件的异步推送机制，客户端向节点发送注册请求，在请求中携带客户端关注的合约事件的参数，节点根据请求参数对请求区块范围的Event Log进行过滤，将结果分次推送给客户端。
1. 注册请求是什么？答：客户端向节点请求推送事件，如果监听到事件则向客户端进行推送。
2. 客户端是什么？是应用落地之后的用户吗？

## 系统合约
区块链以及预编译合约中有一些系统合约，用于管理区块链

## 积分链功能解析
角色:

    银行:授信、承兑
    企业:申请授信、发放积分给用户、接受用户的积分进行消费、申请兑现
    用户:获取积分,消费积分、转增积分

分为3个服务器端:

    银行端：部署在银行的机器 上,银行有至少个节点
    企业端：部署在企业的机器上,企业至少有一个节点
    用户端：托管在企业的或者中间人的机器上,应该至少有一个节点（可以没有节点）

积分的总数应当是不变的，因为在企业手中积分就相当于从银行那里交换来的现金，如果积分凭空减少，那么企业必然亏损。
企业A和企业B之间的积分承兑如何实现？允许为负值？    答：不会存在负值的，因为用户使用积分时是将积分转给企业。

## 积分链存在的意义
企业向银行汇款，银行在链上给企业A,B发行积分，积分交易可查且不可篡改，因此解决了众多企业的信任及核账问题。**因此要确保发行同一种积分的企业在同一群组内，保证积分对双方透明。**

## 单机部署方案
1. 银行端三个节点，一个用于部署应用，一个用于与企业A通信，另一个用于与企业B通信。**为什么说是讲应用部署在节点上呢？**因为如果应用部署在与节点相同的机器上，那么应用就可以通过当前的节点与区块链进行通信。
2. 那么企业A和B分别拥有两个节点吗？分别用于企业间通信和与银行通信。

## 多机部署方案：
在不同机器操作时，请将生成的对应IP的文件夹拷贝到对应机器启动，建链操作只需要执行一次！

## 作业要求
1. AMOP例子：以代码形式提交
2. 项目流程图：提交文档、图
3. API接口文档：提交文档
4. 服务器部署（单机多群组/多机多群组）：服务验证\截图
5. 部署合约，用应用调用：截图

## 合约堆栈过深
在一个方法中定义16个及以上的变量，就会报这个错误

## 账户管理
FISCO BCOS使用账户来标识和区分每一个独立的用户。在采用公私钥体系的区块链系统里，每一个账户对应着一对公钥和私钥。其中，由公钥经哈希等安全的单向性算法计算后得到地址字符串被用作该账户的账户名，即**账户地址**，为了与智能合约的地址相区别和一些其他的历史原因，账户地址也常被称之**外部账户地址**。而仅有用户知晓的私钥则对应着传统认证模型中的密码。用户需要通过安全的密码学协议证明其知道对应账户的私钥，来声明其对于该账户的所有权，以及进行敏感的账户操作。

就是说每个用户有一个地址，企业和银行拥有超级账户。

## 下一步任务：生成账户，并进行限制
消费者需要上链吗？我需要去限制消费者的权限吗？

上链：需要在链上存储一个Table，存储用户余额以及ID，允许用户transfer自己的积分，关于这一块的权限控制归后端还是智能合约有待讨论。由后端验证，后端验证成功后就已经得知账户ID了，再限制只能根据此账户ID进行操作就可以
不上链：在后端数据库存储用户余额，仅仅在线上存储企业的积分余额，不用担心用户的权限管理，不过看起来老师要求在链上存储用户的余额

各任务实现：
1. 积分发行（银行->企业）：issue(company_account, amount )
2. 积分发放（企业->用户）：transfer(from_account, to_account, amount)
3. 用户消费（用户->企业）：transfer(from_account, to_account, amount)
4. 积分承兑（企业->银行）：accept(company_account, amount)  
5. 积分转赠（用户->用户）：transfer(from_account, to_account, amount)

## web3sdk使用
当前任务：找到applicationContext.xml配置文件        
答：这里的配置文件实际在application.yml文件中，包含了AccountConfig.java中的三个private变量。
不过目前找不到solidity的调用文件夹，猜测在web3j的配置中
或许web3j对象在其他配置完成后就可以获取了？        文档中说web3j在application类中初始化了